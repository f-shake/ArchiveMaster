<UserControl
    x:Class="ArchiveMaster.Views.MainView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="clr-namespace:FzLib.Avalonia.Behaviors;assembly=FzLib.Avalonia"
    xmlns:cfg="using:ArchiveMaster.Configs"
    xmlns:ctrl="using:FzLib.Avalonia.Controls"
    xmlns:cvm="clr-namespace:ArchiveMaster.ViewModels;assembly=ArchiveMaster.Core"
    xmlns:cvt="using:ArchiveMaster.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:gb="using:GroupBox.Avalonia.Controls"
    xmlns:ic="using:FluentIcons.Avalonia.MarkupExtensions"
    xmlns:local="clr-namespace:ArchiveMaster.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:ArchiveMaster.Models;assembly=ArchiveMaster.Core"
    xmlns:sys="using:System"
    xmlns:v="using:ArchiveMaster.Views"
    xmlns:vm="clr-namespace:ArchiveMaster.ViewModels"
    x:Name="root"
    d:DesignHeight="450"
    d:DesignWidth="800"
    x:DataType="vm:MainViewModel"
    Background="{DynamicResource Background1}"
    mc:Ignorable="d">
    <UserControl.Resources>
        <sys:TimeSpan x:Key="AnimationDuration">0:0:0.3</sys:TimeSpan>
    </UserControl.Resources>
    <UserControl.Styles>
        <StyleInclude Source="MainViewStyles.axaml" />
    </UserControl.Styles>
    <Design.DataContext>
        <vm:MainViewModel />
    </Design.DataContext>

    <Grid>
        <SplitView
            x:Name="spl"
            Background="Transparent"
            CompactPaneLength="40"
            DisplayMode="CompactInline"
            IsPaneOpen="{Binding Source={x:Static cfg:GlobalConfigs.Instance}, Mode=TwoWay, Path=IsMainViewPaneOpen}"
            OpenPaneLength="200"
            PaneBackground="Transparent">
            <SplitView.Pane>
                <Border>
                    <Grid
                        x:Name="grdLeft"
                        Margin="0,12,0,0"
                        RowDefinitions="*,4,Auto">
                        <!--  主菜单  -->
                        <ScrollViewer
                            AllowAutoHide="True"
                            BringIntoViewOnFocusChange="{Binding ScrollViewBringIntoViewOnFocusChange}"
                            HorizontalScrollBarVisibility="Disabled"
                            VerticalScrollBarVisibility="Auto">
                            <Interaction.Behaviors>
                                <RoutedEventTriggerBehavior RoutedEvent="{x:Static InputElement.KeyDownEvent}">
                                    <InvokeCommandAction Command="{Binding ScrollViewKeyDownCommand}" />
                                </RoutedEventTriggerBehavior>
                                <DataTriggerBehavior
                                    Binding="{Binding #spl.IsPaneOpen}"
                                    Value="False">
                                    <ChangePropertyAction
                                        PropertyName="VerticalScrollBarVisibility"
                                        Value="Hidden" />
                                </DataTriggerBehavior>
                                <DataTriggerBehavior
                                    Binding="{Binding #spl.IsPaneOpen}"
                                    Value="True">
                                    <ChangePropertyAction
                                        PropertyName="VerticalScrollBarVisibility"
                                        Value="Auto" />
                                </DataTriggerBehavior>
                            </Interaction.Behaviors>

                            <ItemsControl
                                x:Name="lstGroups"
                                ItemsSource="{Binding PanelGroups}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel
                                            Orientation="Vertical"
                                            Spacing="16" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Vertical">
                                            <StackPanel
                                                IsVisible="{Binding #spl.IsPaneOpen}"
                                                Orientation="Horizontal">
                                                <TextBlock
                                                    Margin="16,0,4,0"
                                                    FontWeight="Bold"
                                                    Foreground="{DynamicResource Foreground3}"
                                                    Text="{Binding GroupName}"
                                                    ToolTip.Tip="{Binding GroupDescription}" />
                                                <Button
                                                    HorizontalAlignment="Left"
                                                    Classes="Icon"
                                                    Content="{ic:FluentIcon Icon=MoreHorizontal}"
                                                    IsVisible="{Binding MenuItems, Converter={x:Static cvt:Converters.CountGreaterThanZero}}">
                                                    <Button.Flyout>
                                                        <MenuFlyout
                                                            ItemContainerTheme="{StaticResource GroupMenuTheme}"
                                                            ItemsSource="{Binding MenuItems}" />
                                                    </Button.Flyout>
                                                </Button>

                                            </StackPanel>

                                            <ListBox
                                                Background="Transparent"
                                                Classes="Menu"
                                                ItemsSource="{Binding Panels}"
                                                SelectionChanged="SelectingItemsControl_OnSelectionChanged">
                                                <ListBox.Styles>
                                                    <Style Selector="ListBoxItem">
                                                        <Setter Property="ClipToBounds" Value="False" />
                                                    </Style>
                                                </ListBox.Styles>
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid
                                                            ClipToBounds="False"
                                                            ColumnDefinitions="Auto,8,*"
                                                            ToolTip.Tip="{Binding Description}">
                                                            <Svg
                                                                Width="20"
                                                                Height="20"
                                                                Css=".icon { fill: #FF0000; }"
                                                                Path="{Binding IconUri}" />
                                                            <TextBlock
                                                                Grid.Column="2"
                                                                Text="{Binding Title}" />
                                                            <Border
                                                                Width="14"
                                                                Height="14"
                                                                Background="{DynamicResource AccentB3}"
                                                                CornerRadius="7"
                                                                IsVisible="{Binding UseAi}"
                                                                RenderTransform="translate(8px,-8px)">
                                                                <TextBlock
                                                                    Padding="0"
                                                                    HorizontalAlignment="Center"
                                                                    VerticalAlignment="Center"
                                                                    FontSize="8"
                                                                    Foreground="White"
                                                                    RenderTransform="translate(-0.1px,0)"
                                                                    Text="AI" />
                                                            </Border>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                        </ScrollViewer>

                        <!--  设置按钮  -->
                        <StackPanel
                            Grid.Row="2"
                            Margin="10,8"
                            IsVisible="{Binding #spl.IsPaneOpen}"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Button
                                Padding="6"
                                Classes="Icon"
                                Command="{Binding OpenSettingDialogCommand}"
                                Content="{ic:FluentIcon Icon=Settings}"
                                ToolTip.Tip="设置" />
                            <Button
                                Padding="6"
                                Classes="Icon"
                                Command="{Binding OpenMasterPasswordDialogCommand}"
                                Content="{ic:FluentIcon Icon=LockClosedKey}"
                                ToolTip.Tip="密码设置" />
                        </StackPanel>


                        <!--  折叠按钮  -->
                        <ToggleButton
                            Grid.Row="2"
                            Width="32"
                            Margin="8"
                            Padding="6"
                            HorizontalAlignment="Right"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Classes="Split"
                            IsChecked="{Binding #spl.IsPaneOpen}"
                            ToolTip.Tip="折叠">
                            <Interaction.Behaviors>
                                <DataTriggerBehavior
                                    Binding="{Binding #spl.IsPaneOpen}"
                                    Value="False">
                                    <ChangePropertyAction
                                        PropertyName="Content"
                                        Value="{ic:FluentIcon Icon=Navigation}" />
                                </DataTriggerBehavior>
                                <DataTriggerBehavior
                                    Binding="{Binding #spl.IsPaneOpen}"
                                    Value="True">
                                    <ChangePropertyAction
                                        PropertyName="Content"
                                        Value="{ic:FluentIcon Icon=ArrowLeft}" />
                                </DataTriggerBehavior>
                            </Interaction.Behaviors>
                        </ToggleButton>

                    </Grid>
                </Border>
            </SplitView.Pane>

            <Panel>
                <!--  背景图片  -->
                <Grid
                    ColumnDefinitions="*,*,*"
                    RowDefinitions="*,*,*">
                    <Image
                        Grid.Row="1"
                        Grid.Column="1"
                        IsVisible="{Binding #mainContent.Content, Converter={x:Static cvt:Converters.IsNull}}"
                        Opacity="0.3"
                        Source="avares://ArchiveMaster.UI/Assets/icon_transparent.png" />
                </Grid>

                <!--  工具主界面  -->
                <ContentControl
                    x:Name="mainContent"
                    Classes="Main" />
            </Panel>
        </SplitView>


        <ctrl:ProgressRingBoxOverlay
            x:Name="loading"
            Grid.ColumnSpan="3"
            IsActive="{Binding IsProgressRingOverlayActive}" />
    </Grid>
</UserControl>