# 文件加密解密

## 功能特性

1. 使用AES加密算法，对文件进行加密解密
2. 除了支持对文件内容加密外，还支持对文件名、文件夹名或整体目录结构进行加密
3. 支持选择算法的填充模式、算法类型

## 配置

1. 未加密目录/加密后目录：加密前后的目录。注意，加密操作时，将地区未加密目录，写入加密后目录；解密操作时，将读取加密后目录，写入未加密目录
2. 密码：加密或解密的密码。密码最小长度为1位，最大长度为32位。密码将使用PBKDF2密钥派生函数生成AES密钥。
3. 算法参数
   1. 加密算法：AES的加密算法。默认值位ECB。
   2. 填充模式：AES算法的填充模式。默认值为PKCS#7。
   3. 密钥长度：AES算法的密钥长度，支持128位、192位或256位。默认值为256位。

4. 选项
   1. 加密目录结构：开启后，系统会将原始文件名和目录结构通过 SHA256 哈希替换为随机字符串，同时将原始路径信息加密存储到同名的`.$eptm$`元数据文件中，实现完全扁平化存储；解密时则通过读取并解密元数据文件自动还原原始目录层级和文件名，彻底隐藏文件关联性，防止攻击者通过路径或文件名推断敏感内容，确保即使文件被窃取也无法直接获取有效信息。
   2. 当目标文件存在时：设置当目标文件存在的时候，是跳过、报错，还是覆盖。
   3. 删除处理前文件：是否在加密/解密后，删除原文件


##  原理解析

实现了一个基于AES对称加密的文件加密/解密服务，其核心原理是通过AES算法对文件内容进行加密或解密，同时可选择加密目录结构。加密过程使用用户提供的密码通过PBKDF2密钥派生函数生成AES密钥，分块处理文件数据，每个加密文件头部写入随机生成的IV（初始化向量）以确保相同文件多次加密结果不同，支持大文件流式处理（默认1MB缓冲区）和进度报告，解密时自动读取IV并还原文件内容和目录结构，提供覆盖/跳过/报错等文件名冲突处理策略，整体实现了安全可靠的文件加密存储功能。

## AES加密模式

| 加密模式 |         全称          |                        工作原理                        | 是否需要IV |                   安全性                   | 典型应用场景                       |
| :----------: | :-----------------------: | :--------------------------------------------------------: | :------------: | :--------------------------------------------: | :------------------------------------- |
|   ECB    |  Electronic Codebook  |        将明文分成固定大小的块，每个块独立加密。        |   不需要   | 低（相同明文块生成相同密文，易受模式攻击） | 单块数据加密（不推荐用于完整消息） |
|   CBC    | Cipher Block Chaining | 每个明文块先与前一个密文块异或后再加密，首个块使用IV。 |    需要    |      高（IV确保相同明文加密结果不同）      | 文件加密、SSL/TLS                  |
|   OFB    |    Output Feedback    |     将加密的IV反馈至下一块生成密钥流，与明文异或。     |    需要    |             中（错误传播较少）             | 流加密场景（已逐渐被CTR取代）      |
|   CFB    |    Cipher Feedback    |       前一个密文块作为输入加密后与当前明文异或。       |    需要    |      中（支持流加密，但错误传播较多）      | 遗留系统（较少使用）               |

## AES填充模式

| 填充模式  |      全称/标准       |                         填充规则                         |                移除规则                |            适用场景             |               安全性               |
| :-----------: | :----------------------: | :----------------------------------------------------------: | :----------------------------------------: | :---------------------------------: | :------------------------------------: |
|  PKCS#7   |  PKCS #7 (RFC 5652)  | 填充`N`个字节，每个字节值为`N`（如缺4字节则填`0x04 0x04 0x04 0x04`） | 读取最后一个字节值`N`，移除末尾`N`字节 | 最通用（CBC/ECB等需填充的模式） |   高（规范明确，支持任意块大小）   |
| ISO 10126 | ISO 10126-2 (已撤回) | 最后1字节为填充长度，其余填充随机字节（如缺4字节：`0x12 0xAB 0xCD 0x04`） |                同PKCS#7                |    旧金融系统（现较少使用）     |  中（随机性防分析，但标准已弃用）  |
| ANSIX9.23 |      ANSI X9.23      | 最后1字节为填充长度，其余填`0x00`（如缺4字节：`0x00 0x00 0x00 0x04`） |                同PKCS#7                |      传统金融协议（如FIX）      |  中（固定`0x00`可能泄露结构信息）  |
|   Zeros   |        零填充        | 填充`0x00`直到块对齐（如缺4字节：`0x00 0x00 0x00 0x00`） |   需记录原始数据长度（否则无法区分）   |    非加密场景（如文本对齐）     | 低（无法区分填充与真实`0x00`数据） |
|   None    |        无填充        |          数据必须恰好为块大小的整数倍，否则报错          |                 不处理                 |         CTR/GCM等流模式         |   高（但需外部保证数据长度正确）   |

# 目录结构同步

## 功能特性

1. 目录结构同步：根据模板目录的结构自动整理源文件到目标目录，保持一致的文件夹层级。
2. 智能文件匹配：通过文件名、大小或修改时间匹配源文件和模板文件，支持时间误差容差。
3. 复制或移动文件：可自由选择复制（保留源文件）或移动（删除源文件）操作。

## 配置

1. 模板目录：选择作为结构参考的模板文件夹路径。
2. 源目录：选择需要整理或同步的原始文件所在文件夹路径。
3. 目标目录：设置整理后文件输出的目标文件夹路径。
4. 筛选：通过文件类型、名称等条件过滤需要处理的文件。
5. 文件匹配选项：勾选用于匹配文件的属性（名称、大小、修改时间）。
6. 操作选项：选择是否复制文件（保留源文件）或直接移动文件。

## 原理解析

基于属性匹配和目录结构映射实现文件同步。首先，系统会扫描模板目录，提取每个文件的文件名、大小和修改时间等关键属性，并构建哈希表以加速查询。接着遍历源目录文件，通过用户勾选的匹配规则（如名称、大小或时间）在哈希表中快速查找对应模板文件，计算相对路径差异。若匹配成功，则根据用户配置（复制/移动）将源文件同步到目标目录的对应位置，自动创建缺失的子目录。对于多匹配或冲突文件，系统会标记警告并交由用户手动处理，确保同步过程可控。

# 目录结构克隆

## 功能特性

1. 目录结构克隆：复制源目录的完整文件结构，生成相同层级的空文件（稀疏文件）或导出为JSON描述文件。
2. 稀疏文件生成（仅Windows）：创建和源文件大小相同但内容为空的文件，节省磁盘空间。
3. 结构文件导出：将目录结构及文件属性（路径、大小、修改时间）保存为JSON文件，便于迁移或分析。

## 配置

1. 模板目录：选择需要克隆的源文件夹路径。
2. 稀疏文件目录导出：设置生成空文件的输出目录（仅Windows支持）。
3. 结构文件导出：指定JSON文件的保存路径，记录目录结构信息。

## 原理解析

通过递归扫描源目录构建完整的文件树结构（包括路径、大小和修改时间），在克隆时提供两种输出方式：若选择生成稀疏文件（仅Windows支持），则调用系统API（`DeviceIoControl`）快速创建与源文件大小相同但内容为空的文件，既保留目录结构又节省磁盘空间；若选择导出结构文件，则通过JSON序列化完整记录文件树信息（含相对路径、尺寸等元数据），实现跨平台可移植的目录结构快照。整个过程通过异步任务处理大目录，并实时反馈进度，核心解决了目录结构复制与轻量化存储的需求。

# 批量重命名

## 功能特性

1. 支持文件和文件夹两种目标类型的重命名
2. 提供多种搜索模式：包含、匹配扩展名、匹配文件名、匹配全名、正则表达式
3. 供多种重命名模式：替换关键词、替换扩展名、替换文件名、替换全名、保留匹配值、保留匹配值和扩展名、C#脚本高级模式
4. 支持忽略大小写选项
5. 自动处理重命名冲突，确保不会覆盖现有文件
6. 提供C#脚本支持实现高级重命名逻辑

## 配置

1. 目录：选择要进行重命名操作的根目录
2. 搜索关键词：输入用于匹配文件/文件夹名的关键词或正则表达式
3. 替换关键词：输入用于替换匹配部分的内容或C#脚本代码
4. 搜索选项：
   - 类型：选择要重命名的目标是文件还是文件夹
   - 搜索模式：选择搜索匹配方式（包含、匹配扩展名等）
   - 包括子目录：是否包含子目录中的文件/文件夹
   - 忽略大小写：是否忽略大小写进行匹配
5. 重命名选项：
   - 重命名模式：选择重命名方式（替换关键词、替换扩展名等）

## 搜索模式

| 名称       | 说明                                | 示例                                                     |
| -------------- | --------------------------------------- | ------------------------------------------------------------ |
| 包含       | 检查文件名/路径是否包含指定的关键词 | 搜索词：`report`<br>匹配：`report.pdf`, `annual_report.docx`<br>不匹配：`data.txt`, `notes.doc` |
| 匹配扩展名 | 精确匹配文件扩展名（不含点）        | 搜索词：`pdf`<br>匹配：`doc.pdf`, `presentation.PDF`<br>不匹配：`image.png`, `data.xlsx` |
| 匹配文件名 | 精确匹配文件名部分（不含扩展名）    | 搜索词：`invoice`<br>匹配：`invoice.pdf`, `INVOICE.xlsx`<br>不匹配：`invoice_2023.doc`, `old_invoice.txt` |
| 匹配全名   | 精确匹配完整文件名（含扩展名）      | 搜索词：`readme.txt`<br>匹配：`readme.txt`, `README.TXT`<br>不匹配：`readme.md`, `readme.txt.bak` |
| 正则表达式 | 使用正则表达式进行高级匹配          | 搜索词：`^img_\d{4}\.jpg$`<br>匹配：`img_2023.jpg`, `IMG_0001.JPG`<br>不匹配：`image.jpg`, `img123.png` |

注：表格中所有示例均假设开启了"忽略大小写"选项

## 重命名模式

| 名称               | 说明                         | 示例                                                     |
| ---------------------- | -------------------------------- | ------------------------------------------------------------ |
| 替换关键词         | 替换匹配到的部分             | 原文件：`photo_001.jpg`<br>替换为：`image_001.jpg`       |
| 替换扩展名         | 仅替换文件扩展名             | 原文件：`document.doc`<br>替换为：`document.docx`        |
| 替换文件名         | 替换文件名部分（保留扩展名） | 原文件：`old_report.pdf`<br>替换为：`new_report.pdf`     |
| 替换全名           | 完全替换整个文件名           | 原文件：`temp.tmp`<br>替换为：`archive.zip`              |
| 保留匹配值         | 仅保留匹配部分作为新名称     | 原文件：`project_alpha_v1.zip`<br>匹配`[a-z]+(?=_v)`<br>结果：`alpha.zip` |
| 保留匹配值和扩展名 | 保留匹配部分+原扩展名        | 原文件：`20231115_notes.doc`<br>匹配`\d{8}`<br>结果：`20231115.doc` |
| 高级（C#脚本）     | 使用C#代码自定义重命名逻辑   | 脚本：`return "NEW_" + file.Name;`<br>原文件：`test.txt`<br>结果：`NEW_test.txt` |

除高级（C#脚本），其余，模式均支持占位符，见[文件信息占位符](#文件信息占位符)

注：表格中所有示例均假设开启了"忽略大小写"选项

### 高级（C#脚本）重命名模式

C#脚本模式允许用户使用C#代码自定义文件重命名逻辑，适用于复杂或动态的重命名需求。

在 C# 脚本中，可以直接访问以下全局变量：

| 变量      | 类型             | 说明                                   |
| ------------- | -------------------- | ------------------------------------------ |
| `file`    | `RenameFileInfo` | 当前文件的信息（路径、名称、扩展名等） |
| `matched` | `string`         | 匹配到的字符串（取决于搜索模式）       |

`RenameFileInfo` 对象提供以下常用属性：

| 属性           | 类型       | 说明                         | 示例                     |
| :----------------- | :------------- | :------------------------------- | :--------------------------- |
| `Name`         | `string`   | 文件名（包含扩展名）         | `"report.pdf"`           |
| `Path`         | `string`   | 文件的完整绝对路径           | `"C:\Files\report.pdf"`  |
| `RelativePath` | `string`   | 相对于TopDirectory的相对路径 | `"subfolder\report.pdf"` |
| `TopDirectory` | `string`   | 根目录路径                   | `"C:\Files"`             |
| `IsDir`        | `bool`     | 标识是否是文件夹             | `true`（文件夹）         |
| `Length`       | `long`     | 文件大小（字节），文件夹为0  | `1024`（1KB文件）        |
| `Time`         | `DateTime` | 最后修改时间                 | `2023-11-15 14:30:00`    |

代码在“替换关键词”中编写，允许一行或多行，最后一行应当返回一个字符串。例如：

1. 使用哈希值作为文件名：

````csharp
return BitConverter.ToString(MD5.HashData(File.OpenRead(file.Path))).Replace("-", "") + Path.GetExtension(file.Path);
````

2. 移除文件名中的数字：

```csharp
var name = Path.GetFileNameWithoutExtension(file.Name);
var ext = Path.GetExtension(file.Name);
var cleanName = Regex.Replace(name, @"[0-9]", ""); // 移除非字母数字
return cleanName + ext;
```

如：`a1234bcd.ps1`→`abcd.ps1`

3. 根据文件大小分类重命名：

```csharp
var name = Path.GetFileNameWithoutExtension(file.Name);
var ext = Path.GetExtension(file.Name);
var suffix = file.Length < 1024 * 1024 ? "_small" : "_large";
return name + suffix + ext;
```

4. 将形似`aa bb.ext`的文件重命名为`Aa_Bb.ext`：

```csharp
// 获取文件名和扩展名
var nameWithoutExt = Path.GetFileNameWithoutExtension(file.Name);
var extension = Path.GetExtension(file.Name);

// 分割单词并处理每个单词
var words = nameWithoutExt.Split(' ');
var processedWords = words
    .Where(word => !string.IsNullOrEmpty(word))  // 过滤空字符串
    .Select(word => 
        word.Length > 1 
            ? char.ToUpper(word[0]) + word.Substring(1).ToLower()  // 首字母大写，其余小写
            : word.ToUpper()  // 单字符直接大写
    );

// 用下划线连接并添加扩展名
return string.Join("_", processedWords) + extension;
```

5. 为文件添加序号后缀：

```csharp
static int counter = 1;
return $"file_{counter++:000}{Path.GetExtension(file.Name)}";
```

# 重复文件清理

## 功能特性

1. 重复文件清理：自动检测并清理指定目录中与参考目录重复的文件
2. 多重匹配条件：支持按文件名、文件大小和修改时间进行文件匹配
3. 安全删除机制：将删除的文件移动到指定回收站目录而非直接删除
4. 智能分组显示：以树形结构展示重复文件组，便于用户确认

## 配置

1. 待清理目录：选择需要检查重复文件的目录路径
2. 参考目录：设置作为重复判断基准的参考目录路径
3. 删除文件位置：指定删除文件的存放位置，避免文件误删
4. 匹配条件：勾选用于判断文件重复的属性（文件名/大小/修改时间）
5. 时间容差：设置修改时间匹配的允许误差范围（秒）

## 原理解析

通过构建文件特征索引对待清理目录和参考目录中的文件进行多重属性比对，当检测到文件名、大小和修改时间匹配时即判定为重复文件；系统会以参考目录文件为基准，将待清理目录中的重复文件分组显示，用户确认后这些文件会被安全移动到指定回收位置而非直接删除，整个过程采用异步处理并实时反馈进度，确保在清理重复文件的同时避免误删重要数据。

# 根据时间段归档

## 功能特性

1. 时间智能分类：根据文件修改时间自动将文件分组到时间区间目录
2. 自定义时间间隔：可设置最小时间间隔阈值（分钟）控制分类粒度
3. 混合内容处理：同时支持文件和子目录的自动归类

## 配置

1. 目录：选择需要按时间分类整理的文件夹路径
2. 最小间隔：设置时间分组的间隔阈值（单位：分钟），超过该间隔将创建新分组

## 原理解析

通过扫描目录内所有文件和子目录的修改时间，按照用户设定的最小时间间隔进行智能分组：首先将所有项目按时间排序，当相邻项目的时间差超过设定阈值时自动创建新的时间区间分组，最终生成以“起始时间~结束时间”命名的目录结构，并将原始文件/子目录移动到对应时间段的目录中，整个过程保留原始时间属性，实现基于时间维度的自动化文件整理。

该工具没有使用传统的聚类算法（如K-means、DBSCAN等），而是采用了一种基于时间阈值的线性分组方法，其核心逻辑更接近时间序列分段（Segmentation）而非聚类分析。分组完全由时间间隔阈值决定：若相邻文件时间差 > 阈值 → 新建分组；若时间差 ≤ 阈值 → 归入当前分组。工具按文件时间戳严格排序后线性遍历（类似滑动窗口）。

# 附属文件清理

智能识别并清理与主文件（如RAW格式照片）相关联的冗余附属文件（如JPG预览图），帮助专业摄影师和摄影爱好者高效管理存储空间，避免重复文件占用。

## 功能特性

1. 智能模式匹配：支持通配符模式匹配附属文件名（如`{Name}.JPG`、`{Name}(*).JPG`）
2. 多格式支持：可配置多种主文件格式（DNG/ARW/RW2等RAW格式）
3. 安全删除机制：提供可视化确认界面，避免误删重要文件
4. 批量操作支持：可一次性处理目录下所有符合条件的文件组

## 配置说明

1. 目录：选择需要扫描处理的文件夹路径
2. 主文件后缀：设置作为主文件的扩展名列表（如`DNG`、`ARW`、`RW2`）
3. 附属文件模式：定义附属文件的命名模式，需包含`{Name}`通配符。使用简单的`*`和`?`通配符表示任意个或一个任意字符。例如，`{Name}.JPG`匹配同名JPG文件，`*{Name}*.PNG`表示文件名中包含主文件文件名的PNG图像。

## 原理解析

该工具首先扫描目录中符合主文件扩展名的文件，然后根据配置的命名模式（将`{Name}`替换为实际文件名）查找匹配的附属文件。例如主文件`IMG_1234.DNG`会触发对`IMG_1234.JPG`、`IMG_1234(1).JPG`等模式的搜索。找到的附属文件会经用户确认后执行删除操作，整个过程保留原始RAW文件确保数据安全。

# 批量命令行执行

本工具可通过配置指定目录、选择命令行程序并设置参数，利用动态占位符（如`<Path>`、`<DirRelPath>`）自动替换文件路径或生成目录结构，实现对文件或目录的批量处理。工具支持多种文件遍历模式（如全量文件、顶层目录、特定层级元素），适用于自动化脚本执行、文件操作、系统管理等场景，显著提升批量任务的开发效率与管理体验。

## 配置

| 配置名       | 描述                                                     |
| :--------------- | :----------------------------------------------------------- |
| 目录         | 指定需要处理的根目录路径，工具将在此目录下遍历文件或文件夹。支持通过文件选择器直接选择目录，确保路径的正确性。 |
| 程序         | 设置用于执行命令行的程序，可以是一个普通的支持命令行参数的exe，也可以是系统的shell（例如Windows下的`cmd`和`PowerShell`、Linux和MacOS下的`/bin/bash`）。 |
| 命令行参数   | 定义需要执行的命令行参数，必须提供至少一个占位符（如`<Path>`、`<DirRelPath>`），用于动态替换文件路径、相对路径等信息。 |
| 自动创建目录 | 部分命令运行前需要手动创建目标目录。该参数用于指定需要自动创建的目录路径，支持使用占位符动态生成目录结构。例如，`C:\Temp\<DirRelPath>`会根据文件的相对路径自动创建对应的目录结构，确保命令执行前的目录准备。 |
| 列举对象     | 选择需要处理的目标类型，包括文件、目录或混合元素。支持按层级深度检索（如`C:\*\*`二级目录）。 |

## 例子

假设有一个需求，要将`D:\照片`下的目录进行压缩。压缩时，要求对该目录下的每个目录中的目录单独压缩成一个rar压缩包，放到`D:\output`中，例如：

- `D:\照片\宁波\四明山`目录压缩为`D:\output\宁波\四明山.rar`
- `D:\照片\上海\陆家嘴`目录压缩为`D:\output\上海\陆家嘴.rar`
- ……

那么， 模块应该做如下配置：

| 配置名       | 配置值                                 |
| ---------------- | ------------------------------------------ |
| 目录         | `D:\照片`                              |
| 程序         | `C:\Program Files\WinRAR\Rar.exe`      |
| 命令行参数   | `a "D:\output\<RelPath>.rar" "<Path>"` |
| 自动创建目录 | `D:\output\<DirRelPath>`               |
| 列举对象     | 指定深度目录，层数为1                  |

该配置表示，会自动枚举`D:\照片`下，`D:\照片\*`的目录，并调用RAR程序，将每个目录压缩到`D:\output`，并保留相对目录结构。压缩前，会创建目标压缩文件所在的目录，防止压缩出错。

# 硬链接去重

通过智能识别内容相同的文件并创建硬链接，有效减少磁盘空间占用，同时保持文件系统的完整性和可访问性。该工具特别适用于需要存储大量重复文件（如备份数据、版本控制文件等）的场景，通过文件内容哈希比对和硬链接技术，在确保数据安全的前提下实现存储空间优化，避免重复文件占用额外空间。

## 功能特征

1. 重复文件检测：通过计算文件哈希值（支持SHA256等算法）识别内容完全相同的文件
2. 硬链接创建：将重复文件替换为指向同一存储的硬链接，节省磁盘空间
3. 智能分组：按哈希值自动分组相同文件，支持显示文件数量、大小和修改时间
4. 时间容差：可选允许修改时间不同的文件合并（需哈希和大小一致）

## 配置

1. 目录：选择需要检测重复文件的文件夹路径
2. Hash类型：设置文件内容比对算法（如SHA256、MD5等）
3. 允许文件修改日期不同：勾选后允许合并修改时间不同但内容相同的文件
4. 文件过滤：通过扩展名或正则表达式筛选需要处理的文件类型

## 原理解析

该工具首先递归扫描目标目录，通过指定哈希算法计算文件指纹，将相同哈希值的文件归为一组；随后校验每组文件的大小是否一致，并根据配置决定是否忽略修改时间差异；最后对用户确认的分组，保留首个文件作为源，其余文件替换为指向该源的硬链接，从而在不影响文件独立性的前提下合并物理存储，显著节省磁盘空间。过程中采用二分进度反馈和异常处理机制确保可靠性。

