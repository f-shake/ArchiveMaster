# 动态固存备份

## 简介

动态固存备份模块专门解决将动态更新目录中的文件备份到容量有限、写入后不可修改介质（如光盘、一次性磁带）的复杂需求。它通过算法将文件按介质容量分割打包，支持增量备份、完整性验证和加密保护，确保数据长期安全保存，特别适合需要定期归档重要数据的用户。

## 目标用户与解决问题

本工具面向需要将动态更新数据备份到一次性写入介质的用户群体。它能解决的核心问题是：如何将不断变化的目录内容高效备份到容量有限且写入后不可修改的介质中，同时保持数据完整性和目录结构。并且，下次备份时，如何自动跳过已经备份的数据，避免数据冗余。	

## 参数

### 打包

- 源目录：需要进行备份的目录。可以进行筛选。
- 导出目录：数据包导出的位置。导出后的数据将在该目录建立以需要为名称的文件夹或ISO文件。
- 早期文件包：可以添加多个`wpk`格式的包信息文件。这些文件来自在此次备份之前进行备份时生成的目录中，文件中包含了那次备份的时候已经备份的文件的Hash。通过这些信息，程序能够在此次备份时跳过相应的文件，避免重复备份。
- Hash计算缓存：在初始化时，程序需要计算源目录中每个文件的Hash，即文件的唯一特征码。通过Hash的比对，确认文件的内容唯一性。Hash的计算需要读取整个文件，耗时较长，因此在计算时，会同时将计算完的文件和Hash的对应关系写入到处目录中的`whc`文件。通过引入该文件，可以避免在下次初始化时重复计算Hash，节省时间。
- 单文件包容量：通常，一次性写入介质（如光盘）具有固定大小的容量，因此每个介质单体中的总存储大小不能超过该容量。设置该文件包容量，可以方便程序对所有文件进行动态分配。可以从预设中选择各类型光盘的容量值。
- 导出方式
  - 复制：将每个文件复制到对应文件包目录中
  - 硬链接：导出位置与源目录所在位置在统一分区下时，可以为一份物理文件创建两个视图，使导出时速度极快，且不需要消耗磁盘空间
  - ISO：直接打包为ISO文件
- 密码：为导出的文件设置密码。采用AES加密，CBC模式，PKCS7填充，Rfc2898生成密码。仅支持复制模式。

### 重建

- 文件包目录：文件包的位置。可以指定多个文件包，这些文件包中的文件将被一次重建为原始目录结构。
- 重建目录：重建后的文件目录保存的位置
- 强制指定目录结构：在导出的文件包中，存在`package_info.wpk`文件，包含了备份时整个备份目录的目录结构。一般情况下，在选取多个文件包目录时，程序将自动选择最新的`package_info.wpk`文件作为重建目录的参考。也可以通过设置该参数，手动指定`package_info.wpk`。
- 密码：若打包时设置了密码，此处应当输入相同的密码进行解密。否则，置空即可。若输入了密码但实际文件未被加密，则会输入该密码。
- 跳过已存在的文件：若勾选，在目标文件已存在时，将放弃重建当前文件；否则，将报错。
- 仅验证文件完整性：若勾选，则仅对文件打包时计算的Hash与当前物理文件的Hash进行对比，确认文件的完整性；否则，进行实际重建。

## 使用说明

### 打包

1. 填写源目录和导出目录
2. 若非首次备份，则选择早期文件包和Hash缓存
3. 按需设置单文件包容量、导出方式、密码
4. 进行初始化，程序会计算每一个文件的Hash
5. 浏览每个文件包，确认符合要求
6. 点击导出，导出为文件夹或ISO
7. 将文件刻录到介质（如光盘）中

### 恢复操作流程：

1. 插入介质（如光盘），确保可读取。若需要一次性导入，可以先将介质中的文件复制到本地硬盘中。
2. 选择文件包目录、重建目录，按需填写其他参数。
3. 点击初始化
4. 查看目标结构树和需要重建的文件列表，确保无误
5. 点击执行进行重建

## 工作原理

本模块通过哈希比对机制实现增量备份：首次备份时生成包含文件路径、大小、修改时间和SHA-256哈希值的完整文件清单（`WriteOncePackageInfo`）；后续备份时，通过解析历史备份包中的哈希集合（`packagedHashes`）与当前文件哈希缓存（`.whc文件`）比对，自动跳过已备份文件。文件分组采用改进的装箱算法（Bin Packing）：打乱文件顺序后遍历，将每个文件放入文件数据包中，优先保持各数据包文件数量的平衡。备份过程嵌入包含完整目录树和文件哈希的元数据索引（JSON格式），执行刻录前预校验；恢复时通过重新计算目标文件哈希值与索引比对验证完整性，加密备份采用AES-256标准。